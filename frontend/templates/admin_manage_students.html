<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f6f9;
      display: flex;
    }

    .sidebar {
      width: 240px;
      background-color: #1e272e;
      color: white;
      min-height: 100vh;
      padding-top: 20px;
    }

    .sidebar-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .sidebar-header h2 {
      margin: 0;
      font-size: 22px;
      color: #00cec9;
    }

    .sidebar-nav {
      list-style-type: none;
      padding-left: 0;
    }

    .sidebar-nav li {
      padding: 12px 20px;
      border-left: 4px solid transparent;
    }

    .sidebar-nav li a {
      color: #dcdde1;
      text-decoration: none;
      display: block;
      transition: background 0.3s, padding-left 0.3s;
    }

    .sidebar-nav li a i {
      margin-right: 10px;
    }

    .sidebar-nav li:hover {
      background-color: #2f3640;
      padding-left: 25px;
    }

    .sidebar-nav li.active {
      background-color: #2f3640;
      border-left: 4px solid #00cec9;
    }

    .sidebar-nav li.active a {
      color: #00cec9;
    }

    .main-content {
      flex: 1;
      padding: 30px;
      overflow-y: auto;
    }

    h1, h2 {
      margin-bottom: 20px;
      color: #2c3e50;
    }

    .overview-cards {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: linear-gradient(145deg, #ffffff, #e6e6e6);
      padding: 20px;
      width: 280px;
      height: 150px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    }

    .card h3 {
      margin-top: 0;
      color: #0984e3;
      font-size: 25px;
      align-content: center;
    }

    .card p {
      margin: 8px 0;
      font-size: 25px;
      color: #333;
    }


    .modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.6);
}

.modal-content {
  background-color: #fff;
  margin: 8% auto;
  padding: 20px;
  border-radius: 10px;
  width: 80%;
  max-width: 700px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

.close-btn {
  float: right;
  font-size: 22px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-btn:hover {
  color: red;
}

.section {
      background: white;
      padding: 20px;
      margin-top: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }
table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }

    th {
      background-color: #ecf0f1;
    }

    .edit-btn {
  background-color: #0077cc;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  margin-right: 5px;
  cursor: pointer;
}

.edit-btn:hover {
  background-color:  #0077cc;
}

.delete-btn {
  background-color: #e74c3c;
  color: white;
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.delete-btn:hover {
  background-color: #c0392b;
}

  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
    </div>
    <ul class="sidebar-nav">
      <li ><a href="admin_dashboard.html"><i class="fas fa-home"></i> Home</a></li>
      <li class="active"><a href="admin_manage_students.html"><i class="fas fa-user-graduate"></i> Manage Students</a></li>
      <li><a href="admin_manage_teachers.html"><i class="fas fa-chalkboard-teacher"></i> Manage Teachers</a></li>
      <li><a href="admin_manage_subjects.html"><i class="fas fa-book"></i> Manage Subjects</a></li>
      <li><a href="#" onclick="confirmLogout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>

    </ul>
  </nav>
  
  <!-- Manage Students Section -->
<div class="main-content">
  <h2>üë®‚Äçüéì Manage Students</h2>

  <!-- Student Year Cards -->
  <div class="overview-cards">
    <div class="card" onclick="fetchStudentsCRUD(1)"><h3>1st Year</h3><p id="year1Count">--</p></div>
<div class="card" onclick="fetchStudentsCRUD(2)"><h3>2nd Year</h3><p id="year2Count">--</p></div>
<div class="card" onclick="fetchStudentsCRUD(3)"><h3>3rd Year</h3><p id="year3Count">--</p></div>
<div class="card" onclick="fetchStudentsCRUD(4)"><h3>4th Year</h3><p id="year4Count">--</p></div>

  </div>

  <!-- Add Student Button -->
  <button onclick="openStudentModal()" style="margin-bottom: 15px; padding: 10px 15px; background-color: #0984e3; color: white; border: none; border-radius: 5px;">‚ûï Add Student</button>
<div class ="section">
  <!-- Students Table -->
  <table id="studentsTable">
    <thead>
      <tr>
        <th>Username</th>
        <th>PRN</th>
        <th>Mobile</th>
        <th>Email</th>
        <th>Password</th>
        <th>Year</th>
        <th>Fingerprint ID</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- Filled dynamically -->
    </tbody>
  </table>
</div></div>

<!-- Add/Edit Student Modal -->
<div id="studentModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeStudentModal()">&times;</span>
    <h3 id="modalHeader">Add Student</h3>
    <form id="studentForm">
      <input type="hidden" id="edit_prn" name="prn">
      <div style="margin-bottom: 10px;"><input type="text" id="username" placeholder="Username" required style="width: 97%; padding: 8px;"></div>
      <div style="margin-bottom: 10px;"><input type="text" id="prn" placeholder="PRN" required style="width: 97%; padding: 8px;"></div>
      <div style="margin-bottom: 10px;"><input type="text" id="mobile" placeholder="Mobile Number" required style="width: 97%; padding: 8px;"></div>
      <div style="margin-bottom: 10px;"><input type="email" id="email" placeholder="Email" required style="width: 97%; padding: 8px;"></div>
      <div style="margin-bottom: 10px;"><input type="password" id="password" placeholder="password" required style="width: 97%; padding: 8px;"></div>
      <div style="margin-bottom: 10px;">
        <select id="year" required style="width: 100%; padding: 8px;">
          <option value="">Select Year</option>
          <option value="1">1st Year</option>
          <option value="2">2nd Year</option>
          <option value="3">3rd Year</option>
          <option value="4">4th Year</option>
        </select>
      </div>
      <div style="margin-bottom: 10px;">
        <input type="number" id="fingerprint_id" placeholder="Enter Fingerprint ID" required style="width: 70%; padding: 8px;">
        <button type="button" onclick="enrollStudentFingerprint()" style="padding: 8px; background-color: #0984e3; color: white; border: none; border-radius: 5px;">Take Fingerprint</button>
      </div>
      <div id="fingerprint-status" style="margin-top: 5px; color: green;"></div>

      <button type="submit" style="padding: 10px 15px; background-color: green; color: white; border: none; border-radius: 5px;">Save</button>
    </form>
  </div>
</div>

  

<script>
// Manage Students CRUD
function openStudentModal(edit = false, student = {}) {
  document.getElementById("studentModal").style.display = "block";
  document.getElementById("modalHeader").innerText = edit ? "Edit Student" : "Add Student";

  document.getElementById("edit_prn").value = edit ? student.prn : "";
  document.getElementById("username").value = edit ? student.username : "";
  document.getElementById("prn").value = edit ? student.prn : "";
  document.getElementById("prn").readOnly = edit; //  Add this line
  document.getElementById("mobile").value = edit ? student.mobile : "";
  document.getElementById("email").value = edit ? student.email : "";
  document.getElementById("password").value = edit ? student.password : "";
  document.getElementById("year").value = edit ? student.year : "";
  document.getElementById("fingerprint_id").value = edit ? student.fingerprint_id : "";
  document.getElementById("fingerprint-status").innerText = ""; // Clear status

}

function closeStudentModal() {
  document.getElementById("studentModal").style.display = "none";
  document.getElementById("fingerprint-status").innerText = ""; // Clear on close

}

// Load student list on page load
async function fetchStudentsCRUD(year = null) {
  const BACKEND_URL = "http://127.0.0.1:5000";
  try {
    let url = `${BACKEND_URL}/admin/students`;
    if (year) url += `?year=${year}`;

    const res = await fetch(url);
    const data = await res.json();
    const tbody = document.querySelector("#studentsTable tbody");
    tbody.innerHTML = "";

    let yearCounts = { 1: 0, 2: 0, 3: 0, 4: 0 };

    data.students.forEach(student => {
      yearCounts[student.year]++;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${student.username}</td>
        <td>${student.prn}</td>
        <td>${student.mobile}</td>
        <td>${student.email}</td>
        <td>${student.password}</td>
        <td>${student.year}</td>
        <td>${student.fingerprint_id}</td>
        <td>
        <button class="edit-btn" onclick='openStudentModal(true, ${JSON.stringify(student)})'>Edit</button>
        <button class="delete-btn" onclick='deleteStudent("${student.prn}")'>Delete</button>
        </td>`;

      tbody.appendChild(tr);
    });

    // Only update year counts if "All Students" is selected
    if (!year) {
      document.getElementById("year1Count").innerText = yearCounts[1];
      document.getElementById("year2Count").innerText = yearCounts[2];
      document.getElementById("year3Count").innerText = yearCounts[3];
      document.getElementById("year4Count").innerText = yearCounts[4];
    }
  } catch (err) {
    console.error("Error loading students:", err);
  }
}

// Handle Add/Edit submit
document.getElementById("studentForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const student = {
    username: document.getElementById("username").value,
    prn: document.getElementById("prn").value,
    mobile: document.getElementById("mobile").value,
    email: document.getElementById("email").value,
    password: document.getElementById("password").value,
    year: parseInt(document.getElementById("year").value),
    fingerprint_id: parseInt(document.getElementById("fingerprint_id").value),
  };
  
  const BACKEND_URL = "http://127.0.0.1:5000";
  const isEdit = document.getElementById("edit_prn").value !== "";

  const url = `${BACKEND_URL}/admin/${isEdit ? "update_student" : "add_student"}`;
  const method = isEdit ? "PUT" : "POST";

  const res = await fetch(url, {
    method,
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(student),
  });

  const result = await res.json();
  Swal.fire({
  icon: "success",
  title: isEdit ? "Student Updated" : "Student Added",
  text: result.message || "",
  confirmButtonColor: "#0984e3"
  });

  closeStudentModal();
  fetchStudentsCRUD();
});

// Delete student
async function deleteStudent(prn) {
  const BACKEND_URL = "http://127.0.0.1:5000";
  Swal.fire({
  title: "Are you sure?",
  text: "This will delete the student permanently.",
  icon: "warning",
  showCancelButton: true,
  confirmButtonColor: "#d63031",
  cancelButtonColor: "#636e72",
  confirmButtonText: "Yes, delete"
  }).then(async (result) => {
    if (result.isConfirmed) {
      const res = await fetch(`${BACKEND_URL}/admin/delete_student/${prn}`, { method: "DELETE" });
      const resultData = await res.json();
      Swal.fire({
        icon: "success",
        title: "Deleted",
        text: resultData.message || "Student deleted successfully."
      });
      fetchStudentsCRUD();
   }
});

}

async function enrollStudentFingerprint() {
  const fingerprintId = document.getElementById("fingerprint_id").value;
  const statusDiv = document.getElementById("fingerprint-status");
  const BACKEND_URL = "http://127.0.0.1:5000";

  //  Clear previous status
  statusDiv.innerText = "";
  statusDiv.style.color = "black";

  if (!fingerprintId) {
    statusDiv.innerText = "‚ö†Ô∏è Please enter a Fingerprint ID first.";
    statusDiv.style.color = "red";
    return;
  }

  try {
    //  Clear previous enroll result (important!)
    await fetch(`${BACKEND_URL}/clear_enroll_status/${fingerprintId}`, {
      method: "POST"
    });

    statusDiv.innerText = "üü° Sending ID to scanner...";
    statusDiv.style.color = "black";

    //  Send Flask IP to ESP
    const ipRes = await fetch(`${BACKEND_URL}/send_ip_to_esp`, { method: "POST" });
    const ipData = await ipRes.json();

    if (!ipRes.ok || ipData.status !== "ok") {
      statusDiv.innerText = "‚ùå Failed to contact ESP. Check Flask and ESP connection.";
      statusDiv.style.color = "red";
      return;
    }

    //  Start enrollment
    const enrollRes = await fetch(`${BACKEND_URL}/enroll_fingerprint/${fingerprintId}`);
    const enrollData = await enrollRes.json();

    if (enrollData.status === "pending" || enrollData.status === "success") {
      statusDiv.innerText = "üü° Enrollment started. Waiting for scanner...";
      let attempts = 0;
      const maxAttempts = 10;

      const pollResult = async () => {
        const res = await fetch(`${BACKEND_URL}/get_enroll_status/${fingerprintId}`);
        const result = await res.json();

        if (result.status === "success") {
          statusDiv.innerText = `‚úÖ Fingerprint enrolled at ID ${fingerprintId}`;
          statusDiv.style.color = "green";
        } else if (result.status === "fail") {
          statusDiv.innerText = `‚ùå Enrollment failed: ${result.message || "Unknown error"}`;
          statusDiv.style.color = "red";
        } else {
          if (++attempts < maxAttempts) {
            setTimeout(pollResult, 2000);
          } else {
            statusDiv.innerText = "‚ùå Timeout waiting for ESP.";
            statusDiv.style.color = "red";
          }
        }
      };

      setTimeout(pollResult, 2000);
    } else {
      statusDiv.innerText = `‚ùå Failed to start enrollment: ${enrollData.message || "Unknown error"}`;
      statusDiv.style.color = "red";
    }
  } catch (err) {
    console.error(err);
    statusDiv.innerText = "‚ùå Could not connect to Flask or ESP.";
    statusDiv.style.color = "red";
  }
}



function confirmLogout() {
  Swal.fire({
    title: "Are you sure?",
    text: "You will be logged out!",
    icon: "warning",
    showCancelButton: true,
    confirmButtonColor: "#d63031",
    cancelButtonColor: "#636e72",
    confirmButtonText: "Yes, logout"
  }).then((result) => {
    if (result.isConfirmed) {
      localStorage.clear();
      window.location.href = "login.html";
    }
  });
}













// Initial load
document.addEventListener("DOMContentLoaded", () => {
  fetchStudentsCRUD();
});




</script>



  
</body>
</html>
